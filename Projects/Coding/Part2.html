<!DOCTYPE html>

<html lang="en">
<head>
    <title>Quant Finance</title>
    <link rel="stylesheet" href="../../te.css">
    <script src="../../marked.min.js"></script>
    <script src ='../../script.js'></script>
</head>
<body>
<h1>The Quant Testing Framework I use to create profitable strategies: Part 2</h1>
<p>Hierarchy of classes/modules for reference</p>
<ul><code>
<li>Yggdrasil:<ul>
<li>StockAnalyzer</li>
<li>StrategyHelper</li>
<li>market_analy</li>
<li>useful_methods</li></code>
</ul>
</li>
</ul>
<p>Below, I post the module containing the class StrategyHelper and explain in detail.</p>
<ul>
<li><p>Module: strategy_helper.py</p>
<ul>
<li>Contains the class StrategyHelper</li>
<li>class: StrategyHelper<ul>
<li>This creates an instance of a strategy itself, which is independent of the stocks it is acting on.</li>
<li>Instance variables:<ul>
<li>num_points: Approximate number of data points which the strategy will be executed on.</li>
<li>custom: Boolean of whether the data used will be custom (previously exported from Yahoo Finance via yfinance module) or it will be extracted live via the alpaca api</li>
<li>freq: Frequency of trading and data which the strategy is acting on.</li>
<li>shift: Number of days to shift the data given the number of data points. Note that this is done in days regardless of the freq being used.</li>
<li>data: DataFrame of the whole trading strategy. Includes the rolling parameters such as the mean, rolling z score, the entry and exit points of when trades were executed and completed, the closing prices and return of each of the stocks in the portfolio, the closing prices and return of the base, and the date-time of all days in the data set. See the example given below.</li>
<li>results: Dictionary of all the aspects, or metrics, of the trading strategy. Includes quantities like the Sharpe Ratio, profit percentage, beta, and average alpha.</li>
<li>strategy: List with the name of the strategy being used and the parameters of that strategy.</li>
<li>base: Dataframe of the data of the base which the strategy is being compared to, (in this case I just use SP 500)</li>
<li>start: the start date of the data set. Mostly for reference.</li>
<li>end: the end date of the data set. Mostly for reference.</li>
</ul>
</li>
<li>Instance methods:<ul>
<li>reset_params<ul>
<li>Can reset, or use different, parameters for the given instance of the StrategyHelper object.</li>
<li>Parameters are merely freq, num_points, shift, and custom.</li>
</ul>
</li>
<li>get_params<ul>
<li>returns a list containing the parameters of the strategy and the resulting metrics. Mostly for convenience.</li>
<li>run_method</li>
<li>Runs the strategy on a given set of stocks. Mostly for use in the Yggdrasil class constructor.</li>
<li>Parameters<ul>
<li>stock_uni: List of stocks in the portfolio which the strategy will be executed on.</li>
</ul>
</li>
</ul>
</li>
<li>__ mean_rev __<ul>
<li>Private method to execute the logic of mean reversion with the given parameters if that is the strategy which is chosen in the given instance of a test which is defined in Yggdrasil. Executed in run_method.</li>
<li>Parameters:<ul>
<li>stock_uni: the list of stocks the strategy is being tested on</li>
<li>roll_value: the value of the size of the rolling data which will be used in generating the signal for mean reversion. Default value is 20.</li>
<li>cutoff_value: the value of the z-score which will be used as the signal to enter and exit. Default value is 1.5.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>free code:</p>
<ul>
<li>This executes the strategy of mean reversion with parameters of the rolling window having a value of 25 and the signal being a z score of 1.3. It is executed on hourly, custom data of 'AAPL', with the default size of $\approx$ 500 data points being generated. (Note in this case the actual number is 395. The method of data extraction will be made more accurate, but the initial goal was merely to obtain a large enough sample size, regardless of specifics, in order to accurately test the given strategy on different data sets.)</li>
<li>The results of the strategy being evaluated with a set of metrics is given below the code, and the actual documentation of the backtest is given further below. Note that this example is merely for demonstration purposes of the backtesting and strategy generation framework, and the actual example strategy was not used for real alpha generation purposes.</li>
</ul>
</li>
</ul>
<code>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pandas.core.interchange.dataframe_protocol</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataFrame</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">market_analy</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_time_period</span><span class="p">,</span><span class="n">full_stocks</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">useful_methods</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">'display.max_rows'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">'display.max_column'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">'display.width'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">StrategyHelper</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">freq</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span><span class="n">strategy</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">num_points</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">custom</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_points</span> <span class="o">=</span> <span class="n">num_points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom</span> <span class="o">=</span> <span class="n">custom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">strategy</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">strategy</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">get_time_period</span><span class="p">(</span><span class="s1">'base'</span><span class="p">,</span> <span class="n">num_data_points</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_points</span><span class="p">,</span> <span class="n">custom_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">custom</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span>
                                    <span class="n">shift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="s1">''</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="s1">''</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">reset_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">num_points</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">custom</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_points</span> <span class="o">=</span> <span class="n">num_points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom</span> <span class="o">=</span> <span class="n">custom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">param_list</span> <span class="o">=</span><span class="p">{</span><span class="s1">'num points'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_points</span><span class="p">,</span> <span class="s1">'custom'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom</span><span class="p">,</span><span class="s1">'shift'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">,</span><span class="s1">'freq'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="s1">'param data in terms of time attributes'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="s1">'start of the data set'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">),</span> <span class="s1">'end of the data set'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">),</span> <span class="s1">'strategy'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">}</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">param_list</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__mean_rev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stock_uni</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">roll_value</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span><span class="n">cutoff_value</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">):</span>

        
        <span class="c1">#Data Extraction occurs first</span>
        <span class="n">allocation</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">stock_uni</span><span class="p">)):</span>
            <span class="n">allocation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">stock_uni</span><span class="p">))</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'Stock'</span><span class="p">:</span> <span class="n">stock_uni</span><span class="p">,</span> <span class="s1">'Allocation'</span><span class="p">:</span> <span class="n">allocation</span><span class="p">})</span>

        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">skip_stock</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stock_uni</span><span class="p">:</span>
            <span class="n">data_org</span> <span class="o">=</span> <span class="n">get_time_period</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">num_data_points</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_points</span><span class="p">,</span><span class="n">custom_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">custom</span><span class="p">,</span><span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="n">shift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">)</span>
            <span class="n">index_common</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_org</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
            <span class="n">data_org</span> <span class="o">=</span> <span class="n">data_org</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_common</span><span class="p">]</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_common</span><span class="p">]</span>
            <span class="n">data_org</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">base</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">tab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_org</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">skip_stock</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">data_compare</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">roll</span> <span class="o">=</span> <span class="n">roll_value</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tab</span><span class="p">:</span>
             <span class="n">data_compare</span><span class="p">[</span><span class="s1">'Date_Time'</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s1">'Datetime'</span><span class="p">]</span>
             <span class="n">data_compare</span><span class="p">[</span><span class="s1">'close '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stock_uni</span><span class="p">[</span><span class="n">u</span><span class="p">])]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s1">'close'</span><span class="p">]</span>
             <span class="n">data_compare</span><span class="p">[</span><span class="s1">'Daily_return None '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stock_uni</span><span class="p">[</span><span class="n">u</span><span class="p">])]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_compare</span><span class="p">[</span><span class="s1">'close '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stock_uni</span><span class="p">[</span><span class="n">u</span><span class="p">])]</span> <span class="o">-</span> <span class="n">data_compare</span><span class="p">[</span><span class="s1">'close '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stock_uni</span><span class="p">[</span><span class="n">u</span><span class="p">])]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">data_compare</span><span class="p">[</span><span class="s1">'close '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stock_uni</span><span class="p">[</span><span class="n">u</span><span class="p">])]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
             <span class="n">data_compare</span><span class="p">[</span><span class="s1">'Rolling_Mean '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stock_uni</span><span class="p">[</span><span class="n">u</span><span class="p">])]</span> <span class="o">=</span> <span class="n">data_compare</span><span class="p">[</span><span class="s1">'close '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stock_uni</span><span class="p">[</span><span class="n">u</span><span class="p">])]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">roll</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
             <span class="n">data_compare</span><span class="p">[</span><span class="s1">'Rolling_STD '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stock_uni</span><span class="p">[</span><span class="n">u</span><span class="p">])]</span> <span class="o">=</span> <span class="n">data_compare</span><span class="p">[</span>
                <span class="p">[</span><span class="s1">'close '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stock_uni</span><span class="p">[</span><span class="n">u</span><span class="p">])]]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">roll</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
             <span class="n">data_compare</span><span class="p">[</span><span class="s1">'Z Score '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stock_uni</span><span class="p">[</span><span class="n">u</span><span class="p">])]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_compare</span><span class="p">[</span><span class="s1">'close '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stock_uni</span><span class="p">[</span><span class="n">u</span><span class="p">])]</span> <span class="o">-</span> <span class="n">data_compare</span><span class="p">[</span><span class="s1">'Rolling_Mean '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stock_uni</span><span class="p">[</span><span class="n">u</span><span class="p">])])</span><span class="o">/</span><span class="n">data_compare</span><span class="p">[</span><span class="s1">'Rolling_STD '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stock_uni</span><span class="p">[</span><span class="n">u</span><span class="p">])]</span>
             <span class="n">index_drop</span> <span class="o">=</span> <span class="n">data_compare</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">roll</span><span class="p">))]</span>
             <span class="n">data_compare</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index_drop</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
             <span class="n">u</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">data_compare</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">index_common</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_compare</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">data_compare</span> <span class="o">=</span> <span class="n">data_compare</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_common</span><span class="p">]</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_common</span><span class="p">]</span>

        <span class="n">base_</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">base_</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">data_compare</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        
        <span class="c1">#The initial investment is given</span>
        <span class="n">input_money_initial</span> <span class="o">=</span> <span class="mi">10000</span>

        <span class="c1">#The strategy is set up ready to execute with the given parameters </span>
        <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">cutoff_value</span>
        <span class="n">lower_bound</span> <span class="o">=</span> <span class="o">-</span><span class="n">cutoff_value</span>
        <span class="n">base_data</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">'close'</span><span class="p">]</span>
        <span class="n">cur_money</span> <span class="o">=</span> <span class="n">input_money_initial</span>
        <span class="n">columns_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">port</span><span class="p">[</span><span class="s1">'Stock'</span><span class="p">]:</span>
             <span class="n">data_compare</span><span class="p">[</span><span class="s1">'Sell '</span> <span class="o">+</span> <span class="n">stock</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_compare</span><span class="p">[</span><span class="s1">'Z Score '</span> <span class="o">+</span> <span class="n">stock</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">upper_bound</span>
             <span class="n">data_compare</span><span class="p">[</span><span class="s1">'Buy '</span> <span class="o">+</span> <span class="n">stock</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_compare</span><span class="p">[</span><span class="s1">'Z Score '</span> <span class="o">+</span> <span class="n">stock</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lower_bound</span>
             <span class="n">columns_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'Sell '</span> <span class="o">+</span> <span class="n">stock</span><span class="p">)</span>
             <span class="n">columns_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'Buy '</span> <span class="o">+</span> <span class="n">stock</span><span class="p">)</span>
             <span class="n">columns_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'close '</span><span class="o">+</span><span class="n">stock</span><span class="p">)</span>

        <span class="n">buy_counter</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">allocation</span><span class="p">)</span>
        <span class="n">sell_counter</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">allocation</span><span class="p">)</span>
        <span class="n">result_trades</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'Action'</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stock_uni</span><span class="p">),</span><span class="s1">'Hold'</span><span class="p">)],</span> <span class="s1">'Current Amount'</span><span class="p">:</span> <span class="n">cur_money</span><span class="p">,</span> <span class="s1">'Action/DAY Number'</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)})</span>
        <span class="n">trades_pct</span><span class="p">,</span> <span class="n">trades_queue</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">trades_duration</span><span class="p">,</span> <span class="n">trades_duration_final</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="n">duration_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">base_track</span><span class="p">,</span><span class="n">base_queue</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">completed_trades</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">data_compare</span><span class="p">[</span><span class="n">columns_</span><span class="p">]</span>
        <span class="n">alloc</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_money_initial</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">allo</span><span class="p">)</span> <span class="k">for</span> <span class="n">allo</span> <span class="ow">in</span> <span class="n">allocation</span><span class="p">]</span>
        <span class="n">sell_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">allocation</span><span class="p">)))</span> <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">buy_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">allocation</span><span class="p">)))</span> <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">price_inde_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">allocation</span><span class="p">)))</span> <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>

     
        <span class="c1">#This is the execution of the strategy across the given data set</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data_compare</span><span class="o">.</span><span class="n">index</span><span class="p">)):</span>
             <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
             <span class="n">value_sell_list</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">sell_index</span><span class="p">]</span>
             <span class="n">value_buy_list</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">buy_index</span><span class="p">]</span>
             <span class="n">price_list</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">price_inde_x</span><span class="p">]</span>
             <span class="n">duration_counter</span> <span class="o">+=</span><span class="mi">1</span>
             <span class="n">buy</span> <span class="o">=</span> <span class="p">[]</span>
             <span class="k">for</span> <span class="n">value_buy</span><span class="p">,</span><span class="n">value_sell</span><span class="p">,</span><span class="n">price</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">value_buy_list</span><span class="p">,</span> <span class="n">value_sell_list</span><span class="p">,</span><span class="n">price_list</span><span class="p">):</span>
                <span class="n">alloc_</span> <span class="o">=</span> <span class="n">allocation</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="n">cur_money</span> <span class="o">=</span> <span class="n">alloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">alloc_</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value_sell</span> <span class="ow">and</span> <span class="n">cur_money</span> <span class="o">-</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">price</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">:</span>
                       <span class="n">buy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'Sell_short'</span><span class="p">)</span>
                       <span class="n">cur_money</span> <span class="o">=</span> <span class="n">cur_money</span> <span class="o">+</span> <span class="n">price</span>
                       <span class="n">alloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_money</span>
                       <span class="n">sell_counter</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                       <span class="n">trades_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
                       <span class="n">trades_duration</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration_counter</span><span class="p">)</span>
                       <span class="n">base_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">value_buy</span> <span class="ow">and</span> <span class="n">sell_counter</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
                       <span class="n">buy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'Buy_short'</span><span class="p">)</span>
                       <span class="n">cur_money</span> <span class="o">=</span> <span class="n">cur_money</span> <span class="o">-</span> <span class="n">price</span>
                       <span class="n">alloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_money</span>
                       <span class="n">sell_counter</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                       <span class="n">value</span> <span class="o">=</span> <span class="n">trades_queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                       <span class="n">trades_pct</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">price</span> <span class="o">-</span> <span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="n">value</span><span class="p">)</span>
                       <span class="n">trades_duration_final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration_counter</span> <span class="o">-</span> <span class="n">trades_duration</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                       <span class="n">val</span> <span class="o">=</span> <span class="n">base_queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                       <span class="n">base_track</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">base_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">val</span><span class="p">)</span> <span class="o">/</span> <span class="n">val</span><span class="p">)</span>
                       <span class="n">completed_trades</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">alloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_money</span>
                        <span class="n">buy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'Hold_short'</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">alloc_</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value_sell</span> <span class="ow">and</span> <span class="n">buy_counter</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                       <span class="n">buy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'Sell'</span><span class="p">)</span>
                       <span class="n">cur_money</span> <span class="o">=</span> <span class="n">cur_money</span> <span class="o">+</span> <span class="n">price</span>
                       <span class="n">alloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_money</span>
                       <span class="n">buy_counter</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">-=</span><span class="mi">1</span>
                       <span class="n">value</span> <span class="o">=</span> <span class="n">trades_queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                       <span class="n">trades_pct</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">price</span> <span class="o">-</span> <span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="n">value</span><span class="p">)</span>
                       <span class="n">trades_duration_final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration_counter</span> <span class="o">-</span> <span class="n">trades_duration</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                       <span class="n">val</span> <span class="o">=</span> <span class="n">base_queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                       <span class="n">base_track</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">base_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">val</span><span class="p">)</span><span class="o">/</span><span class="n">val</span><span class="p">)</span>
                       <span class="n">completed_trades</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">value_buy</span> <span class="ow">and</span> <span class="n">cur_money</span> <span class="o">-</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">price</span> <span class="o">!=</span> <span class="mi">0</span>  <span class="p">:</span>
                       <span class="n">buy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'Buy'</span><span class="p">)</span>
                       <span class="n">cur_money</span> <span class="o">=</span> <span class="n">cur_money</span> <span class="o">-</span> <span class="n">price</span>
                       <span class="n">alloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_money</span>
                       <span class="n">buy_counter</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
                       <span class="n">trades_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
                       <span class="n">trades_duration</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration_counter</span><span class="p">)</span>
                       <span class="n">base_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">alloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_money</span>
                        <span class="n">buy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'Hold'</span><span class="p">)</span>
                <span class="n">index</span><span class="o">+=</span><span class="mi">1</span>
             <span class="n">result_trades</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">result_trades</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">buy</span><span class="p">],</span> <span class="nb">sum</span><span class="p">(</span><span class="n">alloc</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1">#The results of the completed simulation are stored and computed if needed </span>
        <span class="k">if</span> <span class="n">trades_duration_final</span><span class="p">:</span>
            <span class="n">avg_duration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trades_duration_final</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">avg_duration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">non_cash_profit</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">buy_count</span><span class="p">,</span><span class="n">price</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">buy_counter</span><span class="p">,</span><span class="n">price_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">buy_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">non_cash_profit</span> <span class="o">+=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">buy_count</span>
        <span class="n">profit_pct</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">alloc</span><span class="p">)</span> <span class="o">+</span> <span class="n">non_cash_profit</span> <span class="o">-</span> <span class="n">input_money_initial</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="o">/</span><span class="n">input_money_initial</span>
        <span class="n">input_values_port</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'Upper Bound'</span><span class="p">:</span> <span class="n">upper_bound</span><span class="p">,</span> <span class="s1">'Lower Bound'</span><span class="p">:</span> <span class="n">lower_bound</span><span class="p">,</span> <span class="s1">'Number of Completed Trades'</span><span class="p">:</span> <span class="n">completed_trades</span><span class="p">,</span>
                           <span class="s1">'Average Duration'</span><span class="p">:</span> <span class="n">avg_duration</span><span class="p">,</span> <span class="s1">'Remaining Trades'</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">buy_counter</span><span class="p">),</span><span class="s1">'Final_money'</span> <span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">alloc</span><span class="p">),</span> <span class="s1">'Profit'</span><span class="p">:</span><span class="nb">sum</span><span class="p">(</span><span class="n">alloc</span><span class="p">)</span> <span class="o">+</span> <span class="n">non_cash_profit</span> <span class="o">-</span> <span class="n">input_money_initial</span><span class="p">,</span> <span class="s1">'Profit %'</span><span class="p">:</span> <span class="n">profit_pct</span><span class="p">}</span>
        <span class="n">result_trades</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">result_trades</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data_compare</span><span class="p">,</span><span class="n">result_trades</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_values_port</span><span class="p">,</span> <span class="n">cur</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">data_compare</span><span class="p">[</span><span class="s1">'Date_Time'</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">data_compare</span><span class="p">[</span><span class="s1">'Date_Time'</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1">#The data is analyzed and certain metrics which can be used to track its performance are calculated and stored</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'Current Amount'</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'Current Amount'</span><span class="p">]</span><span class="o">/</span><span class="n">input_money_initial</span>
        <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'Portfolio Return'</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'Current Amount'</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'Base Adj_close '</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'close'</span><span class="p">)</span>
        <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'Base Return'</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'close'</span><span class="p">)</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">buy_tracker</span><span class="p">,</span><span class="n">count</span><span class="p">,</span> <span class="n">sell_tracker</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'Action'</span><span class="p">])</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'Action'</span><span class="p">]:</span>
            <span class="n">track</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="k">if</span> <span class="n">allocation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                   <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'Buy'</span><span class="p">:</span>
                      <span class="n">buy_tracker</span><span class="o">+=</span><span class="mi">1</span>
                   <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'Sell'</span> <span class="ow">and</span> <span class="n">buy_tracker</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                      <span class="n">buy_tracker</span><span class="o">-=</span><span class="mi">1</span>
                   <span class="k">if</span> <span class="n">buy_tracker</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                      <span class="n">track</span><span class="o">+=</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'Buy'</span> <span class="ow">and</span> <span class="n">sell_tracker</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">sell_tracker</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'Sell'</span><span class="p">:</span>
                        <span class="n">sell_tracker</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">sell_tracker</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">track</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">track</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">stock_uni</span><span class="p">):</span>
               <span class="n">index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
            <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'leng before'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])}</span>
        <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">values</span><span class="p">[</span><span class="s1">'leng after'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
             <span class="n">useful_methods</span><span class="o">.</span><span class="n">format_</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">stock_uni</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
             <span class="k">return</span> <span class="kc">None</span>
        <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'Portfolio Return'</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">useful_methods</span><span class="o">.</span><span class="n">format_</span><span class="p">(</span><span class="s1">'N'</span><span class="p">,</span><span class="n">stock</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">pct_exposure</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">/</span><span class="n">total</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">avg_port_return</span><span class="p">,</span> <span class="n">avg_port_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'Portfolio Return'</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'Portfolio Return'</span><span class="p">])</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'Portfolio Return'</span><span class="p">]</span>
        <span class="n">max_list</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="n">draw_</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="n">max_list</span><span class="p">)</span><span class="o">/</span><span class="n">max_list</span>
        <span class="n">draw</span> <span class="o">=</span> <span class="n">draw_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">draw</span> <span class="o">=</span> <span class="n">draw</span><span class="p">[</span><span class="o">~</span><span class="n">draw</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])]</span>
        <span class="n">max_draw</span> <span class="o">=</span> <span class="n">draw</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'Draw down'</span><span class="p">]</span> <span class="o">=</span> <span class="n">draw_</span>
        <span class="k">if</span> <span class="n">avg_port_return</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">avg_port_std</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="n">sharpe_ratio_</span> <span class="o">=</span> <span class="p">(</span><span class="n">avg_port_return</span><span class="p">)</span><span class="o">/</span><span class="n">avg_port_std</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">==</span> <span class="s1">'1d'</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="mi">252</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">==</span> <span class="s1">'1h'</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="mi">252</span><span class="o">*</span><span class="mi">7</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">==</span> <span class="s1">'5m'</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="mi">252</span><span class="o">*</span><span class="mi">7</span><span class="o">*</span><span class="mi">12</span>
        <span class="n">sharpe_ratio_</span> <span class="o">=</span> <span class="n">sharpe_ratio_</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
        <span class="n">cov_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'Portfolio Return'</span><span class="p">]</span> <span class="p">)</span><span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="s1">'Portfolio Return'</span><span class="p">],</span>
                       <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'Base Return'</span><span class="p">]</span> <span class="p">)</span><span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="s1">'Base Return'</span><span class="p">])</span>
        <span class="n">beta_</span> <span class="o">=</span> <span class="n">cov_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">cov_</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">alpha_</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'Portfolio Return'</span><span class="p">]</span> <span class="o">-</span> <span class="n">beta_</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'Base Return'</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta_</span><span class="p">)</span><span class="o">*</span> <span class="mf">.0002</span>
        <span class="n">values_</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'beta'</span><span class="p">:</span> <span class="n">beta_</span><span class="p">,</span><span class="s1">'sharpe ratio'</span><span class="p">:</span> <span class="n">sharpe_ratio_</span><span class="p">,</span> <span class="s1">'avg alpha'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">alpha_</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
                    <span class="s1">'avg std values'</span><span class="p">:</span> <span class="n">avg_port_std</span><span class="p">,</span>
                           <span class="s1">'mean'</span><span class="p">:</span> <span class="n">avg_port_return</span><span class="p">,</span> <span class="s1">'max draw'</span><span class="p">:</span> <span class="n">max_draw</span><span class="p">,</span> <span class="s1">'exposure pct'</span><span class="p">:</span> <span class="n">pct_exposure</span><span class="p">}</span>
        <span class="n">values_</span> <span class="o">=</span> <span class="n">values</span> <span class="o">|</span> <span class="n">values_</span>
        <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'alpha'</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha_</span>
        <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">|</span><span class="n">values_</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span>
            <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">metric</span><span class="p">])</span>

        <span class="c1">#The resulting data of all the completed trades and the results of the performance of this strategy on the given data set are stored to this instance of a test. </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">run_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stock_uni</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="s1">'Mean Rev'</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__mean_rev</span><span class="p">(</span><span class="n">stock_uni</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>


<span class="c1">#free code</span>
<span class="n">ygg_ex</span> <span class="o">=</span> <span class="n">Yggdrasil</span><span class="p">(</span><span class="s1">'h'</span><span class="p">,[</span><span class="s1">'Mean Rev'</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mf">1.3</span><span class="p">],</span><span class="kc">True</span><span class="p">,</span><span class="n">stock_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'AAPL'</span><span class="p">])</span>
<span class="n">useful_methods</span><span class="o">.</span><span class="n">format_</span><span class="p">(</span><span class="s1">'Data'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ygg_ex</span><span class="o">.</span><span class="n">cur_strat</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>                                  <span class="c1">#A display method for convenience </span>
<span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ygg_ex</span><span class="o">.</span><span class="n">cur_strat</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="n">ygg_ex</span><span class="o">.</span><span class="n">cur_strat</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> 
<span class="n">useful_methods</span><span class="o">.</span><span class="n">format_output</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">'Results'</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>                                   <span class="c1">#Another display method for convenience</span>
</code>


<h2 id="Results-and-Data-for-the-Example-given-above">Results and Data for the Example given above</h2><p>Results</p>
<ol>
<li>['Upper Bound', '1.3']</li>
<li>['Lower Bound', '-1.3']</li>
<li>['Number of Completed Trades', '85.0']</li>
<li>['Average Duration', '80.3529']</li>
<li>['Remaining Trades', '13.0']</li>
<li>['Final_money', '7,622.3442']</li>
<li>['Profit', '291.2442']</li>
<li>['Profit %', '2.9124']</li>
<li>['leng before', '471.0']</li>
<li>['leng after', '396.0']</li>
<li>['beta', '0.8832']</li>
<li>['sharpe ratio', '-1.0839']</li>
<li>['avg alpha', '-0.1516']</li>
<li>['avg std values', '0.0248']</li>
<li>['mean', '-0.0004']</li>
<li>['max draw', '-2.4838']</li>
<li>['exposure pct', '84.1102']</li>
</ol>
<p>Data: ->
<a href="https://github.com/sponge-mi-boi/Quant-data/blob/main/Part2_data.md">Link</a></p>

</body>
</html>
